version: '3.3'
  
services:

  mariadb:
    image: mariadb
    restart: always
    environment:
      MYSQL_DATABASE: opencelium
      MYSQL_ROOT_PASSWORD: root
      MYSQL_USER: oc
      MYSQL_PASSWORD: root
    volumes:
      - oc-sql:/docker-entrypoint-initdb.d
      - ./data:/data
      - ./mysql:/var/lib/mysql  

  neo4jdb:
   image: neo4j:3.3.5
   restart: unless-stopped
   ports:
     - 7474:7474
     - 7687:7687
   volumes:
     - ./data:/data
   environment:
     # Raise memory limits
     - NEO4J_dbms_memory_pagecache_size=1G
     - NEO4J_dbms.memory.heap.initial_size=1G
     - NEO4J_dbms_memory_heap_max__size=1G
     - NEO4J_AUTH=neo4j/secret

  netdata:
    image: netdata/netdata:v1.31.0
    container_name: netdata
    ports:
      - 19999:19999
    restart: unless-stopped
    cap_add:
      - SYS_PTRACE
    security_opt:
      - apparmor:unconfined
    volumes:
      - netdataconfig:/etc/netdata
      - netdatalib:/var/lib/netdata
      - netdatacache:/var/cache/netdata
      - /etc/passwd:/host/etc/passwd:ro
      - /etc/group:/host/etc/group:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /etc/os-release:/host/etc/os-release:ro
      - ./tools/oc-mode.html:/usr/share/netdata/web/oc-mode.html
    environment:
      - DOCKER_USR=root
      - PGID=999 # $(getent group docker | cut -d : -f 3)  

  oc-backend:
    container_name: oc-backend
    image: opencelium/opencelium-backend:latest
    depends_on:
      - mariadb
      - neo4jdb
    restart: on-failure
    ports:
      - 9090:9090
    volumes:
      - oc-sql:/backend/database
      - oc-backend:/backend
      - ./invoker/:/backend/src/main/resources/invoker
      - ./templates/:/backend/src/main/resources/templates

  oc-frontend:
    container_name: oc-frontend
    image: opencelium/opencelium-frontend:latest
    restart: on-failure
    volumes:
      - oc-frontend:/frontend
      - /frontend/node_modules
    ports:
      - 8888:8888
    environment:
      - CHOKIDAR_USEPOLLING=true
    command: node server.js --mode production

volumes:
  oc-sql:
  oc-backend:
  oc-frontend:
  netdataconfig:
  netdatalib:
  netdatacache:
