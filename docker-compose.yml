version: '3.3'
  
services:

  mariadb:
    image: mariadb
    restart: always
    environment:
      MYSQL_DATABASE: opencelium
      MYSQL_ROOT_PASSWORD: root
      MYSQL_USER: oc
      MYSQL_PASSWORD: root
    volumes:
      - oc-sql:/docker-entrypoint-initdb.d
      - ./data:/data
      - ./mysql:/var/lib/mysql  

  neo4jdb:
   image: neo4j:3.3.5
   restart: unless-stopped
   ports:
     - 7474:7474
     - 7687:7687
   volumes:
     - ./data:/data
   environment:
     # Raise memory limits
     - NEO4J_dbms_memory_pagecache_size=1G
     - NEO4J_dbms.memory.heap.initial_size=1G
     - NEO4J_dbms_memory_heap_max__size=1G
     - NEO4J_AUTH=neo4j/secret

  oc-backend:
    container_name: oc-backend
    image: opencelium/opencelium-backend:latest
    depends_on:
      - mariadb
      - neo4jdb
    restart: on-failure
    ports:
      - 9090:9090
    volumes:
      - oc-sql:/backend/database
      - ./invoker/:/backend/src/main/resources/invoker
      - ./templates/:/backend/src/main/resources/templates

  oc-frontend:
    container_name: oc-frontend
    image: opencelium/opencelium-frontend:latest
    restart: on-failure
    volumes:
      - /frontend/node_modules
    ports:
      - 8888:8888
    environment:
      - CHOKIDAR_USEPOLLING=true
    command: node server.js --mode production

volumes:
  oc-sql:
